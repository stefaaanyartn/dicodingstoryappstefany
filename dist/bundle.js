(()=>{"use strict";var e={56:(e,n,t)=>{e.exports=function(e){var n=t.nc;n&&e.setAttribute("nonce",n)}},72:e=>{var n=[];function t(e){for(var t=-1,r=0;r<n.length;r++)if(n[r].identifier===e){t=r;break}return t}function r(e,r){for(var a={},i=[],s=0;s<e.length;s++){var c=e[s],d=r.base?c[0]+r.base:c[0],l=a[d]||0,m="".concat(d," ").concat(l);a[d]=l+1;var u=t(m),p={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==u)n[u].references++,n[u].updater(p);else{var h=o(p,r);r.byIndex=s,n.splice(s,0,{identifier:m,updater:h,references:1})}i.push(m)}return i}function o(e,n){var t=n.domAPI(n);return t.update(e),function(n){if(n){if(n.css===e.css&&n.media===e.media&&n.sourceMap===e.sourceMap&&n.supports===e.supports&&n.layer===e.layer)return;t.update(e=n)}else t.remove()}}e.exports=function(e,o){var a=r(e=e||[],o=o||{});return function(e){e=e||[];for(var i=0;i<a.length;i++){var s=t(a[i]);n[s].references--}for(var c=r(e,o),d=0;d<a.length;d++){var l=t(a[d]);0===n[l].references&&(n[l].updater(),n.splice(l,1))}a=c}}},113:e=>{e.exports=function(e,n){if(n.styleSheet)n.styleSheet.cssText=e;else{for(;n.firstChild;)n.removeChild(n.firstChild);n.appendChild(document.createTextNode(e))}}},314:e=>{e.exports=function(e){var n=[];return n.toString=function(){return this.map((function(n){var t="",r=void 0!==n[5];return n[4]&&(t+="@supports (".concat(n[4],") {")),n[2]&&(t+="@media ".concat(n[2]," {")),r&&(t+="@layer".concat(n[5].length>0?" ".concat(n[5]):""," {")),t+=e(n),r&&(t+="}"),n[2]&&(t+="}"),n[4]&&(t+="}"),t})).join("")},n.i=function(e,t,r,o,a){"string"==typeof e&&(e=[[null,e,void 0]]);var i={};if(r)for(var s=0;s<this.length;s++){var c=this[s][0];null!=c&&(i[c]=!0)}for(var d=0;d<e.length;d++){var l=[].concat(e[d]);r&&i[l[0]]||(void 0!==a&&(void 0===l[5]||(l[1]="@layer".concat(l[5].length>0?" ".concat(l[5]):""," {").concat(l[1],"}")),l[5]=a),t&&(l[2]?(l[1]="@media ".concat(l[2]," {").concat(l[1],"}"),l[2]=t):l[2]=t),o&&(l[4]?(l[1]="@supports (".concat(l[4],") {").concat(l[1],"}"),l[4]=o):l[4]="".concat(o)),n.push(l))}},n}},365:(e,n,t)=>{t.d(n,{A:()=>s});var r=t(601),o=t.n(r),a=t(314),i=t.n(a)()(o());i.push([e.id,":root {\n  --primary: #2ecc71;\n  --secondary: #3498db;\n  --background: #f5f5dc;\n  --dark: #2c3e50;\n  --light: #ffffff;\n  --error: #d32f2f;\n}\n\nhtml, body{\n  height: 100%;\n  margin: 0;\n  display: flex;\n  flex-direction: column;\n}\n\n* {\n  box-sizing: border-box;\n}\n\nbody {\n  font-family: 'Segoe UI', sans-serif;\n  margin: 0;\n  padding: 0;\n  background-color: var(--background);\n  color: var(--dark);\n}\n\nheader {\n  background-color: var(--primary);\n  color: var(--light);\n  padding: 1rem 2rem;\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\n}\n\nheader h1 {\n  margin: 0;\n  font-size: 1.8rem;\n}\n\n.header-buttons {\n  display: flex;\n  gap: 0.75rem;\n}\n\n.add-button, .home-button, .auth-button {\n  color: var(--light);\n  background-color: var(--dark);\n  padding: 0.5rem 1rem;\n  text-decoration: none;\n  border-radius: 8px;\n  border: none;\n  cursor: pointer;\n  font-weight: 500;\n  transition: background-color 0.3s ease;\n}\n\n.add-button:hover,\n.home-button:hover,\n.auth-button:hover {\n  background-color: var(--secondary);\n}\n\n#logout-button {\n  display: none;\n}\n\nmain {\n  flex: 1;\n  padding: 2rem;\n  max-width: 1200px;\n  margin: 0 auto;\n  width: 100%;\n}\n\n.story-list {\n  display: grid;\n  grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));\n  gap: 2rem;\n  padding: 2rem 1rem;\n}\n\n.story-item {\n  background-color: var(--light);\n  border-radius: 12px;\n  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);\n  overflow: hidden;\n  transition: transform 0.2s ease;\n  display: flex;\n  flex-direction: column;\n  max-height: 100%;\n}\n\n.story-item:hover {\n  transform: scale(1.01);\n}\n\n.story-item img {\n  width: 100%;\n  height: 200px;\n  object-fit: cover;\n}\n\n.story-item .content {\n  padding: 1rem;\n  display: flex;\n  flex-direction: column;\n  gap: 0.5rem;\n}\n\n.story-item h3 {\n  margin: 0;\n  color: var(--primary);\n  font-size: 1.1rem;\n}\n\n.story-item p {\n  margin: 0;\n  font-size: 0.95rem;\n  line-height: 1.5;\n}\n\n.story-map {\n  height: 200px;\n  margin-top: 1rem;\n  border-radius: 8px;\n  border: 1px solid #ccc;\n}\n\n.add-form, .auth-form {\n  max-width: 600px;\n  background-color: var(--light);\n  padding: 2rem;\n  margin: 2rem auto;\n  border-radius: 10px;\n  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);\n}\n\n.add-form h2,\n.auth-form h2 {\n  text-align: center;\n  color: var(--dark);\n}\n\n.add-form input,\n.add-form textarea,\n.auth-form input {\n  width: 100%;\n  padding: 0.75rem;\n  margin-bottom: 1rem;\n  border: 1px solid #ccc;\n  border-radius: 6px;\n  font-size: 1rem;\n}\n\n.add-form button,\n.auth-form button {\n  width: 100%;\n  padding: 0.75rem;\n  background-color: var(--primary);\n  color: white;\n  border: none;\n  border-radius: 6px;\n  cursor: pointer;\n  font-size: 1rem;\n  transition: background-color 0.3s ease;\n}\n\n.add-form button:hover,\n.auth-form button:hover {\n  background-color: var(--secondary);\n}\n\n.loading,\n.error,\n.empty-state {\n  text-align: center;\n  padding: 2rem;\n  font-size: 1.2rem;\n}\n\n.loading {\n  color: #666;\n}\n\n.error {\n  color: var(--error);\n}\n\n.error button {\n  background-color: var(--error);\n  color: white;\n  border: none;\n  padding: 0.5rem 1rem;\n  border-radius: 4px;\n  margin-top: 1rem;\n  cursor: pointer;\n}\n\n.empty-state {\n  color: #666;\n}\n\n.empty-state .add-button {\n  display: inline-block;\n  margin-top: 1rem;\n  background-color: var(--primary);\n  color: white;\n  padding: 0.5rem 1rem;\n  border-radius: 6px;\n  border: none;\n  text-decoration: none;\n  cursor: pointer;\n}\n\n.auth-form p {\n  text-align: center;\n  margin-top: 1rem;\n}\n\n.auth-form a {\n  color: var(--primary);\n  text-decoration: none;\n}\n\n.auth-form a:hover {\n  text-decoration: underline;\n}\n\n.skip-to-content {\n  position: absolute;\n  top: -40px;\n  left: 10px;\n  background: var(--dark);\n  color: var(--light);\n  padding: 0.75rem 1rem;\n  z-index: 999;\n  text-decoration: none;\n  transition: top 0.3s;\n  font-weight: bold;\n  border-radius: 6px;\n  clip: rect(1px, 1px, 1px, 1px);\n  white-space: nowrap;\n  overflow: hidden;\n}\n\n.skip-to-content:focus {\n  top: 100px;\n  clip: auto;\n  overflow: visible;\n}\n\nfooter {\n  text-align: center;\n  padding: 1.5rem;\n  background-color: var(--primary);\n  color: var(--light);\n}\n\n/* Transisi Halus antar Halaman */\n.fade-enter {\n  opacity: 0;\n  transform: translateY(10px);\n}\n\n.fade-enter-active {\n  opacity: 1;\n  transform: translateY(0);\n  transition: opacity 0.3s ease, transform 0.3s ease;\n}\n\n.fade-exit {\n  opacity: 1;\n  transform: translateY(0);\n}\n\n.fade-exit-active {\n  opacity: 0;\n  transform: translateY(10px);\n  transition: opacity 0.3s ease, transform 0.3s ease;\n}\n\n.overview {\n  max-width: 800px;\n  margin: 2rem auto;\n  padding: 1rem 1.5rem;\n  background-color: var(--light);\n  border-radius: 10px;\n  text-align: center;\n  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);\n}\n\n.overview h2 {\n  color: var(--primary);\n  margin-bottom: 0.5rem;\n}\n\n.overview p {\n  font-size: 1rem;\n  color: var(--dark);\n  line-height: 1.6;\n}\n\n\n.clear-cache-btn {\n  background-color: #e74c3c;     \n  color: #fff;                    \n  border: none;                  \n  padding: 0.6em 1.2em;          \n  font-size: 1rem;               \n  font-weight: bold;\n  border-radius: 8px;            \n  cursor: pointer;             \n  box-shadow: 0 4px 8px rgba(0,0,0,0.1); \n  transition: background-color 0.3s ease, transform 0.2s ease;\n  margin-bottom: 1.5em;\n}\n\n.clear-cache-btn:hover {\n  background-color: #c0392b;     \n  transform: translateY(-2px);   \n}\n\n.clear-cache-btn:active {\n  transform: translateY(0);      \n  background-color: #a93226;\n}\n",""]);const s=i},540:e=>{e.exports=function(e){var n=document.createElement("style");return e.setAttributes(n,e.attributes),e.insert(n,e.options),n}},601:e=>{e.exports=function(e){return e[1]}},659:e=>{var n={};e.exports=function(e,t){var r=function(e){if(void 0===n[e]){var t=document.querySelector(e);if(window.HTMLIFrameElement&&t instanceof window.HTMLIFrameElement)try{t=t.contentDocument.head}catch(e){t=null}n[e]=t}return n[e]}(e);if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(t)}},825:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var n=e.insertStyleElement(e);return{update:function(t){!function(e,n,t){var r="";t.supports&&(r+="@supports (".concat(t.supports,") {")),t.media&&(r+="@media ".concat(t.media," {"));var o=void 0!==t.layer;o&&(r+="@layer".concat(t.layer.length>0?" ".concat(t.layer):""," {")),r+=t.css,o&&(r+="}"),t.media&&(r+="}"),t.supports&&(r+="}");var a=t.sourceMap;a&&"undefined"!=typeof btoa&&(r+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(a))))," */")),n.styleTagTransform(r,e,n.options)}(n,e,t)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(n)}}}}},n={};function t(r){var o=n[r];if(void 0!==o)return o.exports;var a=n[r]={id:r,exports:{}};return e[r](a,a.exports,t),a.exports}t.n=e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},t.d=(e,n)=>{for(var r in n)t.o(n,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:n[r]})},t.o=(e,n)=>Object.prototype.hasOwnProperty.call(e,n),t.nc=void 0;var r=t(72),o=t.n(r),a=t(825),i=t.n(a),s=t(659),c=t.n(s),d=t(56),l=t.n(d),m=t(540),u=t.n(m),p=t(113),h=t.n(p),g=t(365),f={};f.styleTagTransform=h(),f.setAttributes=l(),f.insert=c().bind(null,"head"),f.domAPI=i(),f.insertStyleElement=u(),o()(g.A,f),g.A&&g.A.locals&&g.A.locals;const y=(e,n)=>n.some((n=>e instanceof n));let v,b;const w=new WeakMap,x=new WeakMap,k=new WeakMap;let E={get(e,n,t){if(e instanceof IDBTransaction){if("done"===n)return w.get(e);if("store"===n)return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return I(e[n])},set:(e,n,t)=>(e[n]=t,!0),has:(e,n)=>e instanceof IDBTransaction&&("done"===n||"store"===n)||n in e};function S(e){E=e(E)}function C(e){return"function"==typeof e?(n=e,(b||(b=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(n)?function(...e){return n.apply(B(this),e),I(this.request)}:function(...e){return I(n.apply(B(this),e))}):(e instanceof IDBTransaction&&function(e){if(w.has(e))return;const n=new Promise(((n,t)=>{const r=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",a),e.removeEventListener("abort",a)},o=()=>{n(),r()},a=()=>{t(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",o),e.addEventListener("error",a),e.addEventListener("abort",a)}));w.set(e,n)}(e),y(e,v||(v=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,E):e);var n}function I(e){if(e instanceof IDBRequest)return function(e){const n=new Promise(((n,t)=>{const r=()=>{e.removeEventListener("success",o),e.removeEventListener("error",a)},o=()=>{n(I(e.result)),r()},a=()=>{t(e.error),r()};e.addEventListener("success",o),e.addEventListener("error",a)}));return k.set(n,e),n}(e);if(x.has(e))return x.get(e);const n=C(e);return n!==e&&(x.set(e,n),k.set(n,e)),n}const B=e=>k.get(e),T=["get","getKey","getAll","getAllKeys","count"],D=["put","add","delete","clear"],A=new Map;function P(e,n){if(!(e instanceof IDBDatabase)||n in e||"string"!=typeof n)return;if(A.get(n))return A.get(n);const t=n.replace(/FromIndex$/,""),r=n!==t,o=D.includes(t);if(!(t in(r?IDBIndex:IDBObjectStore).prototype)||!o&&!T.includes(t))return;const a=async function(e,...n){const a=this.transaction(e,o?"readwrite":"readonly");let i=a.store;return r&&(i=i.index(n.shift())),(await Promise.all([i[t](...n),o&&a.done]))[0]};return A.set(n,a),a}S((e=>({...e,get:(n,t,r)=>P(n,t)||e.get(n,t,r),has:(n,t)=>!!P(n,t)||e.has(n,t)})));const j=["continue","continuePrimaryKey","advance"],M={},F=new WeakMap,H=new WeakMap,O={get(e,n){if(!j.includes(n))return e[n];let t=M[n];return t||(t=M[n]=function(...e){F.set(this,H.get(this)[n](...e))}),t}};async function*R(...e){let n=this;if(n instanceof IDBCursor||(n=await n.openCursor(...e)),!n)return;const t=new Proxy(n,O);for(H.set(t,n),k.set(t,B(n));n;)yield t,n=await(F.get(t)||n.continue()),F.delete(t)}function z(e,n){return n===Symbol.asyncIterator&&y(e,[IDBIndex,IDBObjectStore,IDBCursor])||"iterate"===n&&y(e,[IDBIndex,IDBObjectStore])}S((e=>({...e,get:(n,t,r)=>z(n,t)?R:e.get(n,t,r),has:(n,t)=>z(n,t)||e.has(n,t)})));const N="stories",U=function(e,n,{blocked:t,upgrade:r,blocking:o,terminated:a}={}){const i=indexedDB.open(e,n),s=I(i);return r&&i.addEventListener("upgradeneeded",(e=>{r(I(i.result),e.oldVersion,e.newVersion,I(i.transaction),e)})),t&&i.addEventListener("blocked",(e=>t(e.oldVersion,e.newVersion,e))),s.then((e=>{a&&e.addEventListener("close",(()=>a())),o&&e.addEventListener("versionchange",(e=>o(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),s}("story-app-db",1,{upgrade(e){e.objectStoreNames.contains(N)||e.createObjectStore(N,{keyPath:"id"})}}),_={async putStories(e){const n=[];for(const t of e)try{const e=await fetch(t.photoUrl),r=await e.blob();n.push({...t,imageBlob:r})}catch(e){console.warn("Gagal ambil gambar untuk story",t.id,e),n.push(t)}const t=(await U).transaction(N,"readwrite"),r=t.objectStore(N);for(const e of n)r.put(e);await t.done},getAllStories:async()=>(await U).getAll(N),async clearStories(){try{const e=await U;console.log("[IndexedDB] DB:",e);const n=e.transaction(N,"readwrite"),t=n.objectStore(N);console.log("[IndexedDB] Clearing store:",N),await t.clear(),await n.done,console.log("[IndexedDB] Clear successful")}catch(e){throw console.error("[IndexedDB] Error clearing store:",e),e}}},W=class{constructor(){this.baseUrl="https://story-api.dicoding.dev/v1"}get token(){return localStorage.getItem("authToken")||""}async getStories(){if(!this.token)return{error:!0,message:"Unauthorized access. Please login first."};try{const e=await fetch(`${this.baseUrl}/stories?location=1`,{headers:{Authorization:`Bearer ${this.token}`}}),n=await e.json();return!n.error&&n.listStory&&await _.putStories(n.listStory),n}catch(e){return{error:!0,message:"Failed to fetch from API, using cached data",listStory:await _.getAllStories(),offline:!0}}}async addStory({photo:e,description:n,lat:t,lon:r}){const o=new FormData;o.append("photo",e),o.append("description",n),void 0!==t&&void 0!==r&&(o.append("lat",t),o.append("lon",r));try{const e=await fetch(`${this.baseUrl}/stories`,{method:"POST",headers:{Authorization:`Bearer ${this.token}`},body:o});return await e.json()}catch(e){return{error:!0,message:e.message}}}async login({email:e,password:n}){try{const t=await fetch(`${this.baseUrl}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:n})}),r=await t.json();return!r.error&&r.loginResult&&localStorage.setItem("authToken",r.loginResult.token),r}catch(e){return{error:!0,message:e.message}}}async register({name:e,email:n,password:t}){try{const r=await fetch(`${this.baseUrl}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,email:n,password:t})});return await r.json()}catch(e){return{error:!0,message:e.message}}}};function $(e){const n=(e+"=".repeat((4-e.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),t=window.atob(n);return Uint8Array.from([...t].map((e=>e.charCodeAt(0))))}const K=class{constructor(){this.mainContent=document.getElementById("main-content")}showLoading(){this.mainContent.innerHTML='<div class="loading">Loading stories...</div>'}showStories(e){this.mainContent.innerHTML="";const n=document.createElement("button");if(n.innerText="Hapus Data Story",n.className="clear-cache-btn",n.style.marginBottom="1em",n.addEventListener("click",(()=>{confirm("Yakin ingin menghapus cache lokal?")&&this.onClearCache?.()})),this.mainContent.appendChild(n),!e||0===e.length)return this.showEmpty();if("#/"===window.location.hash){const e=document.createElement("section");e.className="overview",e.innerHTML="\n      <h2>Selamat datang di Story App!</h2>\n      <p>\n        Story App adalah aplikasi sederhana untuk berbagi cerita disertai lokasi.\n        Kamu bisa mengunggah foto, menulis cerita, dan melihat cerita orang lain lengkap dengan peta lokasi.\n      </p>",this.mainContent.appendChild(e)}const t=document.createElement("div");t.className="story-list",e.forEach((e=>{const n=document.createElement("div");n.className="story-item";const r=document.createElement("h3");r.textContent=e.name||"Anonymous",n.appendChild(r);let o=e.photoUrl;if(e.imageBlob&&(o=URL.createObjectURL(e.imageBlob)),o){const t=document.createElement("img");t.src=o,t.alt=e.description||"Story image",t.crossOrigin="anonymous",t.loading="lazy",n.appendChild(t)}const a=document.createElement("p");a.textContent=e.description||"",n.appendChild(a);const i=document.createElement("p");if(i.textContent=e.createdAt?new Date(e.createdAt).toLocaleString():"",n.appendChild(i),e.lat&&e.lon){const t=document.createElement("div");t.className="story-map",t.id=`map-${e.id}`,n.appendChild(t)}n.appendChild(document.createElement("hr")),t.appendChild(n)})),this.mainContent.appendChild(t),e.forEach((e=>{e.lat&&e.lon&&requestAnimationFrame((()=>{const n=document.getElementById(`map-${e.id}`);if(n&&n.offsetWidth>0){n._leaflet_map_instance&&(n._leaflet_map_instance.remove(),n.innerHTML="");const t=L.map(n).setView([e.lat,e.lon],13);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap contributors"}).addTo(t),L.marker([e.lat,e.lon]).addTo(t).bindPopup(`<b>${e.name||"Anonymous"}</b><br>${e.description||""}<br><i>${new Date(e.createdAt).toLocaleString()}</i>`),t.invalidateSize(),n._leaflet_map_instance=t}}))}))}showEmpty(){this.mainContent.innerHTML='\n        <div class="empty-state">\n          <p>No stories found</p>\n          <a href="#/add" class="add-button">Add your first story</a>\n        </div>'}showError(e){this.mainContent.innerHTML=`\n        <div class="error">\n          <p>${e}</p>\n          <button onclick="window.location.reload()">Try Again</button>\n        </div>`}setClearCacheHandler(e){this.onClearCache=e}showAddForm(){const e=this;this.mainContent.innerHTML='\n        <div class="add-form">\n          <h2>Add New Story</h2>\n          <video id="camera-preview" autoplay playsinline></video>\n          <button id="capture-button">Ambil Foto</button>\n          <canvas id="photo-canvas" style="display:none;"></canvas>\n          <textarea id="description" placeholder="Your story..." required></textarea>\n          <div id="location-map" class="story-map"></div>\n          <button id="submit-story">Submit</button>\n        </div>';let n=null,t=null;const r=document.getElementById("camera-preview"),o=document.getElementById("photo-canvas"),a=document.getElementById("capture-button"),i=document.getElementById("submit-story");return navigator.mediaDevices.getUserMedia({video:!0}).then((e=>(n=e,r.srcObject=n,new Promise((e=>{r.onloadedmetadata=()=>{r.play(),e()}}))))).catch((e=>{console.error("Gagal mengakses kamera:",e)})),a.addEventListener("click",(()=>{o.width=r.videoWidth,o.height=r.videoHeight,o.getContext("2d").drawImage(r,0,0),o.toBlob((e=>{e?(t=new File([e],"story-photo.jpg",{type:"image/jpeg"}),n&&n.getTracks().forEach((e=>e.stop())),r.remove(),a.remove()):alert("Berhasil membuka kamera.")}),"image/jpeg")})),setTimeout((()=>{const n=document.getElementById("location-map"),t=n.cloneNode(!1);n.parentNode.replaceChild(t,n);const r=L.map(t).setView([-6.2088,106.8456],13);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(r),r.invalidateSize();let o=null;e.selectedLocation=null,r.on("click",(n=>{o&&r.removeLayer(o),o=L.marker(n.latlng).addTo(r),e.selectedLocation=n.latlng}))}),200),i.addEventListener("click",(()=>{try{n&&n.getTracks().forEach((e=>e.stop()))}catch(e){console.error("Kesalahan saat submit:",e)}})),{getFormData:()=>({photo:t,description:document.getElementById("description").value,lat:e.selectedLocation?.lat,lon:e.selectedLocation?.lng}),setSubmitHandler:e=>{document.getElementById("submit-story").addEventListener("click",e)},stopCamera:()=>{n&&n.getTracks().forEach((e=>e.stop()))}}}showLoginForm(){return this.mainContent.innerHTML='\n        <div class="auth-form">\n          <h2>Login</h2>\n          <input type="email" id="login-email" placeholder="Email" required>\n          <input type="password" id="login-password" placeholder="Password" required>\n          <button id="login-submit">Login</button>\n          <p>Don\'t have an account? <a href="#/register">Register here</a></p>\n        </div>',{getLoginData:()=>({email:document.getElementById("login-email").value,password:document.getElementById("login-password").value}),setLoginHandler:e=>{document.getElementById("login-submit").addEventListener("click",e)}}}showRegisterForm(){return this.mainContent.innerHTML='\n        <div class="auth-form">\n          <h2>Register</h2>\n          <input type="text" id="register-name" placeholder="Name" required>\n          <input type="email" id="register-email" placeholder="Email" required>\n          <input type="password" id="register-password" placeholder="Password" required>\n          <button id="register-submit">Register</button>\n          <p>Already have an account? <a href="#/login">Login here</a></p>\n        </div>',{getRegisterData:()=>({name:document.getElementById("register-name").value,email:document.getElementById("register-email").value,password:document.getElementById("register-password").value}),setRegisterHandler:e=>{document.getElementById("register-submit").addEventListener("click",e)}}}},q=class{constructor(){this.model=new W,this.view=new K,this.currentForm=null,this.initRouter()}init(){this.showPage(window.location.hash),this.view.setClearCacheHandler((async()=>{try{await _.clearStories(),alert("Cache berhasil dihapus."),this.showStoriesPage()}catch(e){console.error("Gagal menghapus cache:",e),alert("Terjadi kesalahan saat menghapus cache.")}}))}initRouter(){window.addEventListener("hashchange",(()=>{this.showPage(window.location.hash)}))}showPage(e){const n=document.getElementById("main-content");n&&(this.currentForm&&this.currentForm.stopCamera(),n.classList.remove("fade-enter-active"),n.classList.add("fade-exit"),setTimeout((()=>{n.classList.add("fade-exit-active")}),10),setTimeout((()=>{switch(e){case"#/add":this.model.token?this.showAddPage():(alert("Please login first"),window.location.hash="#/login");break;case"#/login":this.showLoginPage();break;case"#/register":this.showRegisterPage();break;default:this.model.token?this.showStoriesPage():(alert("Please login first"),window.location.hash="#/login")}n.classList.remove("fade-exit","fade-exit-active"),n.classList.add("fade-enter"),setTimeout((()=>{n.classList.add("fade-enter-active")}),10)}),300))}async showStoriesPage(){this.view.showLoading();const e=await this.model.getStories();console.log("Fetched:",e),e.error&&e.offline?(this.showOfflineMessage?.(),this.view.showStories(e.listStory||[])):e.error?this.view.showError(e.message):this.view.showStories(e.listStory)}showAddPage(){const e=this.view.showAddForm();this.currentForm=e,e.setTakePhotoHandler((()=>{e.stopCamera()})),e.setSubmitHandler((async()=>{const n=e.getFormData();if(!n.photo||!n.description)return alert("Fill photo & description");if(!n.lat||!n.lon)return alert("Choose location on map");const t=await this.model.addStory(n);t.error?alert(t.message):(alert("Story added!"),window.location.hash="#/")}))}showLoginPage(){const e=this.view.showLoginForm();e.setLoginHandler((async()=>{const{email:n,password:t}=e.getLoginData();if(!n||!t)return alert("Fill email/password");const r=await this.model.login({email:n,password:t});if(r.error)alert(r.message);else{alert("Login Successful!");const e=r.loginResult.token;localStorage.setItem("authToken",e),async function(e){if("serviceWorker"in navigator)try{const n=await navigator.serviceWorker.ready,t=await n.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:$("BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk")}),r=JSON.stringify({endpoint:t.endpoint,keys:{p256dh:t.getKey("p256dh")?btoa(String.fromCharCode(...new Uint8Array(t.getKey("p256dh")))):"",auth:t.getKey("auth")?btoa(String.fromCharCode(...new Uint8Array(t.getKey("auth")))):""}}),o=await fetch("https://story-api.dicoding.dev/v1/notifications/subscribe",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:r}),a=await o.json();if(!o.ok||a.error)throw new Error(a.message||"Failed to subscribe");console.log("Subscribed to push notification 🎉")}catch(e){console.error("Push subscription error:",e)}else console.warn("Service Worker not supported!")}(e),window.location.hash="#/"}}))}showRegisterPage(){const e=this.view.showRegisterForm();e.setRegisterHandler((async()=>{const{name:n,email:t,password:r}=e.getRegisterData();if(!n||!t||!r)return alert("Fill all fields");const o=await this.model.register({name:n,email:t,password:r});o.error?alert(o.message):(alert("Registration successful, please login."),window.location.hash="#/login")}))}showOfflineMessage(){const e=document.getElementById("main-content"),n=document.createElement("div");n.innerText="⚠️ Kamu sedang offline. Menampilkan data tersimpan.",n.style.background="#fffae6",n.style.color="#333",n.style.padding="1em",n.style.marginBottom="1em",n.style.border="1px solid #ccc",n.style.borderRadius="8px",e.prepend(n)}};localStorage.getItem("authToken")||"#/"!==location.hash||(location.hash="#/login"),document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("hapus-story");(new q).init();const n=()=>{const e=!!localStorage.getItem("authToken");document.getElementById("login-button").style.display=e?"none":"block",document.getElementById("register-button").style.display=e?"none":"block",document.getElementById("logout-button").style.display=e?"block":"none"};n(),document.getElementById("logout-button").addEventListener("click",(()=>{localStorage.removeItem("authToken"),n(),window.location.hash="#/",window.location.reload()})),window.clearAppCache=()=>{window.presenter?.view?.onClearCache&&window.presenter.view.onClearCache()},"serviceWorker"in navigator&&window.addEventListener("load",(()=>{navigator.serviceWorker.register("/service-worker.js").then((e=>{console.log("SW registered: ",e)})).catch((e=>{console.error("SW registration failed: ",e)}))})),e&&e.addEventListener("click",(async()=>{if(confirm("Yakin ingin menghapus semua data story?"))try{await IndexedDB.clearStories(),alert("Data story berhasil dihapus dari IndexedDB."),console.log("Semua data story telah dihapus.")}catch(e){console.error("Gagal menghapus data:",e),alert("Terjadi kesalahan saat menghapus data.")}}))}))})();